pipeline{
    agent any

    tools {
        maven 'Maven 3.8.7'
    }

    environment {
        PATH = "/usr/local/bin:${env.PATH}"
        DOCKERHUB_CREDENTIALS_ID = 'Docker-Hub'
        DOCKERHUB_REPO = 'kak3r/lampotila'
        DOCKER_IMAGE_TAG = 'latest'
    }

    stages{

      stage('check') {
          steps {
            git url: 'https://github.com/Kasanen/Week5Assignment.git', branch: 'main'
          }
      }

      stage('Run Tests') {
          steps {
              sh 'mvn clean test'
          }
      }

      stage('Code Coverage') {
          steps {
              sh 'mvn jacoco:report'
          }
      }

      stage('Publish Test Results') {
          steps {
              junit '**/target/surefire-reports/*.xml'
          }
      }

      stage('Publish Coverage Report') {
          steps {
              jacoco()
          }
      }

      stage('Build Docker Image') {
          steps {
              script {
                  docker.build("${DOCKERHUB_REPO}:${DOCKER_IMAGE_TAG}")
              }
          }
      }

      stage('Push Docker Image to Docker Hub') {
          steps {
              script {
                  docker.withRegistry('https://index.docker.io/v1/', DOCKERHUB_CREDENTIALS_ID) {
                      docker.image("${DOCKERHUB_REPO}:${DOCKER_IMAGE_TAG}").push()
                  }
              }
          }
      }
 
    }
}